# Linux Modulos Cheatsheet

## Índice
- [Linux Modulos Cheatsheet](#linux-modulos-cheatsheet)
  - [Índice](#índice)
  - [MODULOS](#modulos)
    - [Configuracion](#configuracion)
    - [Tipos de modulos](#tipos-de-modulos)
    - [Listado de modulos cargados (lsmod)](#listado-de-modulos-cargados-lsmod)
    - [Informacion del modulo cargados (modinfo)](#informacion-del-modulo-cargados-modinfo)
    - [Compilando un modulo desde shell](#compilando-un-modulo-desde-shell)
    - [Limpiando el compilado desde shell](#limpiando-el-compilado-desde-shell)
    - [Makefile basico](#makefile-basico)
    - [Informacion del modulo compilado (modinfo)](#informacion-del-modulo-compilado-modinfo)
    - [Cargar el modulo (insmod)](#cargar-el-modulo-insmod)
    - [Cargar el modulo y dependencias (modprobe)](#cargar-el-modulo-y-dependencias-modprobe)
    - [Generacion de dependencias entre modulos (depmod)](#generacion-de-dependencias-entre-modulos-depmod)
    - [Eliminar el modulo](#eliminar-el-modulo)
    - [Estructura basica](#estructura-basica)
    - [Macros de metadatos](#macros-de-metadatos)
    - [Paso de parametros al modulo (module\_param(...))](#paso-de-parametros-al-modulo-module_param)
      - [Sintaxis general](#sintaxis-general)
      - [Tipos de datos para parametros](#tipos-de-datos-para-parametros)
      - [Permisos](#permisos)
      - [Ejemplo](#ejemplo)
      - [Arrays de datos como parametros (module\_param\_array(...))](#arrays-de-datos-como-parametros-module_param_array)
      - [Arrays de datos como parametros (module\_param\_array\_named(...))](#arrays-de-datos-como-parametros-module_param_array_named)
      - [Consulta de los parametros de un modulo](#consulta-de-los-parametros-de-un-modulo)
      - [Pasar parametros durante la carga](#pasar-parametros-durante-la-carga)
      - [Visualizacion en el FS (si los permisos son distintos de 0)](#visualizacion-en-el-fs-si-los-permisos-son-distintos-de-0)
    - [Proceso de compilado del modulo](#proceso-de-compilado-del-modulo)
  - [SIMBOLOS (SYMBOL)](#simbolos-symbol)
    - [Symbol Table](#symbol-table)
    - [Exportar Symbols](#exportar-symbols)
    - [Extra symbols](#extra-symbols)
    - [Examinar las secciones de un modulo](#examinar-las-secciones-de-un-modulo)
    - [Examinar el contenido de una seccion](#examinar-el-contenido-de-una-seccion)

## MODULOS

### Configuracion
El kernel tiene que estar compilado con la opcion CONFIG_MODULES

``` bash
$ cat /boot/config-$(uname -r) | grep CONFIG_MODULES
CONFIG_MODULES_USE_ELF_RELA=y
CONFIG_MODULES=y
CONFIG_MODULES_TREE_LOOKUP=y
```

### Tipos de modulos 
1. In-Source Tree: Modulos incluidos en el codigo fuente del Kernel de Linux
                   Se encuentran en /lib/modules/{kernel_version}/kernel
2. Out-of-Tree: Modulos no incluidos en el codigo fuente del Kernel de Linux

### Listado de modulos cargados (lsmod)
``` bash
$ lsmod
Module                  Size  Used by
tls                   155648  0
stp                    12288  1 bridge
...
nft_compat             20480  6
nf_tables             376832  71 nft_compat,nft_chain_nat
```

### Informacion del modulo cargados (modinfo)
``` bash
$ modinfo nft_compat
filename:       /lib/modules/6.8.0-83-generic/kernel/net/netfilter/nft_compat.ko
description:    x_tables over nftables support
alias:          nft-expr-target
alias:          nft-expr-match
author:         Pablo Neira Ayuso <pablo@netfilter.org>
license:        GPL
alias:          nfnetlink-subsys-11
srcversion:     D3B2421CDBEE29B16EECA34
depends:        nfnetlink,x_tables,nf_tables
retpoline:      Y
intree:         Y
name:           nft_compat
vermagic:       6.8.0-83-generic SMP preempt mod_unload modversions 
sig_id:         PKCS#7
signer:         Build time autogenerated kernel key
sig_key:        XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX
sig_hashalgo:   sha512
signature:      XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX

```

### Compilando un modulo desde shell
Desde el directorio donde esta module.c
``` bash
make -C /lib/modules/`uname -r`/build M=${PWD} modules
```

### Limpiando el compilado desde shell
Desde el directorio donde esta module.c
``` bash
make -C /lib/modules/`uname -r`/build M=${PWD} clean
```

### Makefile basico
``` bash
obj-m = module_name.o
module_name-objs := file1.o file2.o

all:
    make -C /lib/modules/$(shell uname -r)/build M=$(PWD) modules
clean:
    make -C /lib/modules/$(shell uname -r)/build M=$(PWD) clean
```

### Informacion del modulo compilado (modinfo)
``` bash
$ modinfo ./test_module.ko
filename:       /path/to/module/test_module.ko
license:        GPL
srcversion:     93D66C3F0AA4FDD8C22B72B
depends:        
retpoline:      Y
name:           test_module
vermagic:       6.8.0-83-generic SMP preempt mod_unload modversions 
```

### Cargar el modulo (insmod)
``` bash
$ sudo insmod ./test_module.ko
```

### Cargar el modulo y dependencias (modprobe)
``` bash
$ sudo modprobe test_module.ko
```
solo funciona con modulos que esten en /lib/modules/{kernel_version}/

### Generacion de dependencias entre modulos (depmod)
depmod calcula las dependencias de todos los módulos presentes en la carpeta "/lib/modules/{kernel_version}/", y coloca la información de dependencias en el archivo "/lib/modules/{kernel_version}/modules.dep"

``` bash
$ sudo depmod -a
$ cat /lib/modules/$(uname -r)/modules.dep
...
kernel/arch/x86/kernel/cpuid.ko:
kernel/arch/x86/crypto/twofish-x86_64.ko: kernel/crypto/twofish_common.ko
kernel/arch/x86/crypto/twofish-x86_64-3way.ko: kernel/arch/x86/crypto/twofish-x86_64.ko kernel/crypto/twofish_common.ko
...
```
* cpuid.ko no tiene dependencias
* twofish-x86_64.ko tiene una dependencia
* twofish-x86_64-3way.ko tiene dos dependencias

### Eliminar el modulo
``` bash
$ sudo rmmod ./test_module.ko
```

### Estructura basica 
```c
#include <linux/kernel.h>
#include <linux/module.h>

char *modname = __stringify(KBUILD_MODNAME);
MODULE_LICENSE("GPL");

static int new_module_init(void)
{
    printk("%s: Module Name:%s Loaded\n", __func__, modname);
    ...
    return 0;
}
module_init(new_module_init);

static void new_module_exit(void)
{
    printk("%s: Module Name:%s Removed\n", __func__, modname);
    ...
}
module_exit(new_module_exit);

MODULE_AUTHOR("AMR");
MODULE_DESCRIPTION("Descripcion del modulo");
```

### Macros de metadatos
```c
MODULE_LICENSE("GPL");
MODULE_AUTHOR("Antonio Morales <antonio1010.mr@gmail.com>");
MODULE_DESCRIPTION("Driver de ejemplo para ...");
MODULE_VERSION("1.0");
MODULE_ALIAS("gpio_led_driver");					// Define alias para autoload con modprobe
```
Estos metadatos se pueden visualizar con `modinfo`

### Paso de parametros al modulo (module_param(...))
Es posible pasarle parametros al modulo cuando se carga con `insmod` o `modprobe` y de esta forma
cambiar el comportamiento del modulo sin recompilarlo
    * Definir direcciones IO en el momento de la carga del modulo
    * Habilitar/desabilitar debu logs/printk
    * Ajustar el modo de funcionamiento si el driver soporta distintos modos

#### Sintaxis general
```c
module_param(nombre, tipo, permisos);
```

#### Tipos de datos para parametros
* int: número entero.
* long: número largo.
* short: número corto.
* uint: entero sin signo.
* ulong: entero largo sin signo.
* bool: acepta 0/1, y/n, true/false al pasar el parámetro.
* charp: puntero a cadena (string, tipo char *).
* invbool: como bool, pero invierte el valor (true → false).

#### Permisos
* 0444	Solo lectura para todos
* 0644	Lectura todos, escritura root (más usado)
* 0600	Lectura/escritura solo root
* 0666	Lectura/escritura todos (no recomendable)
* 0		No expone el parámetro en sysfs
* S_IRUGO → “readable by user, group, others” (equivalente a 0444)
* S_IWUSR → “writable by user” (equivalente a 0200)
* S_IRUSR → “readable by user” (equivalente a 0400)

#### Ejemplo
```c
...
#include <linux/moduleparam.h>

// Valores por defecto para los parametros
static int myint = 42;
static char *mystring = "default";
static bool myflag = false;

// Declaracion del parametro y su descripcion
module_param(myint, int, 0644);
MODULE_PARM_DESC(myint, "Un entero de ejemplo");

module_param(mystring, charp, 0644);
MODULE_PARM_DESC(mystring, "Una cadena de ejemplo");

module_param(myflag, bool, 0644);
MODULE_PARM_DESC(myflag, "Un booleano de ejemplo");
...
MODULE_LICENSE("GPL");
MODULE_AUTHOR("AMR");
MODULE_DESCRIPTION("Ejemplo de paso de parámetros");

```

#### Arrays de datos como parametros (module_param_array(...))
```c
module_param_array(nombre, tipo, numerop, permisos);
```
`numerop` puede ser NULL si no se quiere recibir el numero de parametros.

```c
#include <linux/moduleparam.h>

#define MAX_ARRAY 5

static int myarray[MAX_ARRAY];
static int arr_argc = 0;   // aquí se guarda cuántos elementos pasan

module_param_array(myarray, int, &arr_argc, 0444);
MODULE_PARM_DESC(myarray, "Un array de enteros");
```
Si se pasan menos parametros de MAX_ARRAY se rellenaran a 0. Si se pasan mas, dara error al insertar el modulo.

#### Arrays de datos como parametros (module_param_array_named(...))
```c
module_param_array(nombre, tipo, numerop, permisos);
```

#### Consulta de los parametros de un modulo
```bash
$ modinfo modulo.ko
filename:       /path/to/modulo/modulo.ko
description:    Ejemplo de paso de parámetros
author:         AMR
...
vermagic:       6.8.0-83-generic SMP preempt mod_unload modversions 
parm:           myint:Un entero de ejemplo (int)
parm:           mystring:Una cadena de ejemplo (charp)
parm:           myflag:Un booleano de ejemplo (bool)
```

#### Pasar parametros durante la carga
Cuiado con los string que contengan espacios. Añadir commillas simples a la cadena
```bash
$ sudo insmod ./modulo.ko myint=5 mystring="HELLO"
$ sudo insmod ./modulo.ko mystring='"HELLO WORLD"'
$ sudo insmod ./modulo.ko myarray=1,2,3,4
```

#### Visualizacion en el FS (si los permisos son distintos de 0)
```c
$ /sys/module/{my_module}/parameters/{my_parameter}
```

### Proceso de compilado del modulo
```
             ┌────────────────┐
             │   modulo.c     │   (código fuente)
             └───────┬────────┘
                     │
                     ▼
             ┌────────────────┐
             │   modulo.o     │   (objeto intermedio)
             └───────┬────────┘
                     │
        ┌────────────┴───────────────┐
        │                            │
        ▼                            ▼
┌────────────────┐          ┌───────────────────┐
│ modulo.mod.c   │ (autogen)│  modules.order    │ (lista de módulos)
└───────┬────────┘          └───────────────────┘
        │
        ▼
┌────────────────┐
│ modulo.mod.o   │   (objeto con info del módulo)
└───────┬────────┘
        │
        ▼
┌────────────────┐
│  modulo.ko     │   (módulo final, cargable en kernel)
└────────────────┘


Otros ficheros auxiliares:
──────────────────────────
- Module.symvers   : símbolos exportados/importados
- modulo.mod       : dependencias del módulo
- .modulo.ko.cmd   : receta de compilación
```


## SIMBOLOS (SYMBOL)
Un simbolo es cualquier funcion o variable definida en el modulo

### Symbol Table
- Estructura de datos creada por el compilador que contiene todos los símbolos utilizados en el programa.
- Cada imagen del kernel que compilas incluye una tabla de símbolos.
- La tabla de símbolos del kernel de Linux contiene los nombres y direcciones de todos los símbolos del kernel.
- Cuando instalas el kernel, estará presente en `/boot/System.map-<linux_version>`
- Los simbolos de los modulos out the tree se encuentran en `/proc/kallsyms`

```bash
$ sudo cat /boot/System.map-$(uname -r)
...
ffffffff83f90c90 b pci_mmcfg_arch_init_failed
ffffffff83f90c91 b pci_mmcfg_running_state
ffffffff83f90c98 B xen_pci_frontend
ffffffff83f90ca0 b l1ss_header
ffffffff83f90ca4 b prev_header
...
```
- Direccion virtual del simbolo memoria
- Tipo de simbolo:
    - T: símbolo global en text section (código, función exportada).
    - t: símbolo local en text section.
    - D: símbolo global en data section (variable global).
    - d: símbolo local en data section.
    - R: símbolo global en read-only data.
    - r: símbolo local en read-only data.
    - B: símbolo en BSS section (variables no inicializadas).
    - b: lo mismo pero local.
    - V: variable (global, exportada).
    - v: variable local.
    - W: símbolo débil global (puede ser sobrescrito por otro de mayor prioridad).
    - w: simbolo debil local.
    - A: símbolo absoluto (no cambia de dirección aunque se reubique). absoluto (no cambia de dirección aunque se reubique).
    - a: simbolo absoluto local.
    - ?: símbolo desconocido.
- nombre del simbolo

```bash
$ awk '{print $2}' /proc/kallsyms | sort | uniq -c | sort -nr
 132499 t
  63590 T
  46507 d
  38084 r
   4234 b
   4202 D
    850 B
    400 A
    316 W
     63 R
     12 a
      4 w
      1 V
```

```bash
$ sudo awk '{print $2}' /boot/System.map-$(uname -r) | sort | uniq -c | sort -nr
  77187 t
  61964 T
  37664 d
  14928 r
   4288 D
   3534 b
    838 B
    316 W
     55 R
      4 A
      1 V
```

### Exportar Symbols
Cualquier funcion o variable definida en un modulo tiene caracter local por defecto.

Para exportar esta función y permitir que otros módulos la utilicen, es necesario usar las macros:
  * EXPORT_SYMBOL(...): Exporta el simbolo para ser usado por cualquier modulo del kernel.
  * EXPORT_SYMBOL_GPL(...): Exporta el simbolo para ser usado solamente por modulos del kernel con licencia GPL

Una vez exportadas, estarán disponibles para que otros módulos las usen.

### Extra symbols
A veces, un módulo externo utiliza símbolos exportados desde otro módulo externo.

kbuild necesita tener conocimiento completo de todos los símbolos para evitar mostrar advertencias sobre símbolos indefinidos.

Cuando se compila un módulo externo, se genera un archivo Module.symvers que contiene todos los símbolos exportados que no están definidos en el kernel.

Utiliza KBUILD_EXTRA_SYMBOLS y proporciona la ruta al archivo Module.symvers si este se encuentra en un directorio diferente al del módulo.

```Makefile
obj-m := my_modulo.o

KBUILD_EXTRA_SYMBOLS := /path/to/imported/module/Module.symvers
```
### Examinar las secciones de un modulo
```shell
$ objdump --section-headers ./mod_info.ko
./mod_info.ko:     formato del fichero elf64-x86-64

Secciones:
Idx Name          Size      VMA               LMA               File off  Algn
  0 .note.gnu.build-id 00000024  0000000000000000  0000000000000000  00000040  2**2
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
  1 .note.Linux   00000030  0000000000000000  0000000000000000  00000064  2**2
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
  2 .text         00000000  0000000000000000  0000000000000000  00000094  2**0
                  CONTENTS, ALLOC, LOAD, READONLY, CODE
  3 .exit.text    00000015  0000000000000000  0000000000000000  000000a0  2**4
                  CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE
  4 .init.text    0000004b  0000000000000000  0000000000000000  000000c0  2**4
                  CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE
  5 .rodata.str1.1 0000001d  0000000000000000  0000000000000000  0000010b  2**0
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
  6 __mcount_loc  00000008  0000000000000000  0000000000000000  00000128  2**0
                  CONTENTS, ALLOC, LOAD, RELOC, READONLY, DATA
  7 .modinfo      000000b3  0000000000000000  0000000000000000  00000130  2**0
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
  8 .return_sites 00000008  0000000000000000  0000000000000000  000001e3  2**0
                  CONTENTS, ALLOC, LOAD, RELOC, READONLY, DATA
...
```

### Examinar el contenido de una seccion
```bash
$ objdump --section-headers --section=.modinfo --full-contents ./mod_info.ko

./mod_info.ko:     formato del fichero elf64-x86-64

Secciones:
Idx Name          Size      VMA               LMA               File off  Algn
  7 .modinfo      000000b3  0000000000000000  0000000000000000  00000130  2**0
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
Contenido de la sección .modinfo:
 0000 6c696365 6e73653d 47504c00 76657273  license=GPL.vers
 0010 696f6e3d 312e3000 4f533d4c 696e7578  ion=1.0.OS=Linux
 0020 006e616d 653d456d 62656464 65640073  .name=Embedded.s
 0030 72637665 7273696f 6e3d3037 33433245  rcversion=073C2E
 0040 46363642 36453132 45433942 46363646  F66B6E12EC9BF66F
 0050 34006465 70656e64 733d0072 6574706f  4.depends=.retpo
 0060 6c696e65 3d59006e 616d653d 6d6f645f  line=Y.name=mod_
 0070 696e666f 00766572 6d616769 633d362e  info.vermagic=6.
 0080 382e302d 38332d67 656e6572 69632053  8.0-83-generic S
 0090 4d502070 7265656d 7074206d 6f645f75  MP preempt mod_u
 00a0 6e6c6f61 64206d6f 64766572 73696f6e  nload modversion
 00b0 732000                               s .             
```

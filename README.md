# Linux Kernel Programming Cheatsheet

## Índice

- [Linux Kernel Programming Cheatsheet](#linux-kernel-programming-cheatsheet)
  - [Índice](#índice)
  - [MODULOS](#modulos)
    - [Configuracion](#configuracion)
    - [Tipos de modulos](#tipos-de-modulos)
    - [Listado de modulos cargados (lsmod)](#listado-de-modulos-cargados-lsmod)
    - [Informacion del modulo cargados (modinfo)](#informacion-del-modulo-cargados-modinfo)
    - [Compilando un modulo desde shell](#compilando-un-modulo-desde-shell)
    - [Limpiando el compilado desde shell](#limpiando-el-compilado-desde-shell)
    - [Makefile basico](#makefile-basico)
    - [Informacion del modulo compilado (modinfo)](#informacion-del-modulo-compilado-modinfo)
    - [Cargar el modulo (insmod)](#cargar-el-modulo-insmod)
    - [Cargar el modulo y dependencias (modprobe)](#cargar-el-modulo-y-dependencias-modprobe)
    - [Generacion de dependencias entre modulos (depmod)](#generacion-de-dependencias-entre-modulos-depmod)
    - [Eliminar el modulo](#eliminar-el-modulo)
    - [Estructura basica](#estructura-basica)
    - [Macros de metadatos](#macros-de-metadatos)
    - [Paso de parametros al modulo (module\_param(...))](#paso-de-parametros-al-modulo-module_param)
      - [Sintaxis general](#sintaxis-general)
      - [Tipos de datos para parametros](#tipos-de-datos-para-parametros)
      - [Permisos](#permisos)
      - [Ejemplo](#ejemplo)
      - [Arrays de datos como parametros (module\_param\_array(...))](#arrays-de-datos-como-parametros-module_param_array)
      - [Arrays de datos como parametros (module\_param\_array\_named(...))](#arrays-de-datos-como-parametros-module_param_array_named)
      - [Consulta de los parametros de un modulo](#consulta-de-los-parametros-de-un-modulo)
      - [Pasar parametros durante la carga](#pasar-parametros-durante-la-carga)
      - [Visualizacion en el FS (si los permisos son distintos de 0)](#visualizacion-en-el-fs-si-los-permisos-son-distintos-de-0)
    - [Proceso de compilado del modulo](#proceso-de-compilado-del-modulo)
  - [SIMBOLOS (SYMBOL)](#simbolos-symbol)
    - [Symbol Table](#symbol-table)
    - [Exportar Symbols](#exportar-symbols)
    - [Extra symbols](#extra-symbols)
    - [Examinar las secciones de un modulo](#examinar-las-secciones-de-un-modulo)
    - [Examinar el contenido de una seccion](#examinar-el-contenido-de-una-seccion)
  - [LOGS](#logs)
    - [El buffer circular de mensajes del kernel (dmesg)](#el-buffer-circular-de-mensajes-del-kernel-dmesg)
      - [Ver mensajes](#ver-mensajes)
      - [Borrar el buffer](#borrar-el-buffer)
      - [Borrarlo sin representarlo](#borrarlo-sin-representarlo)
      - [No imprimir timestamps](#no-imprimir-timestamps)
      - [Imprimir timestamps human ready](#imprimir-timestamps-human-ready)
      - [Imprimir solo mensajes con cierto nivel de prioridad](#imprimir-solo-mensajes-con-cierto-nivel-de-prioridad)
      - [Imprimir prioridad de los mensajes al inicio del mensaje](#imprimir-prioridad-de-los-mensajes-al-inicio-del-mensaje)
    - [Tamaño del log](#tamaño-del-log)
    - [Memory dumps](#memory-dumps)
      - [Volcado del stack](#volcado-del-stack)
    - [Mensajes Oops](#mensajes-oops)
    - [Volcados condicionales](#volcados-condicionales)
      - [BUG() o BUG\_ON(condition)](#bug-o-bug_oncondition)
      - [WARN() o WARN\_ON(condition)](#warn-o-warn_oncondition)
  - [THREADS](#threads)

## MODULOS

### Configuracion
El kernel tiene que estar compilado con la opcion CONFIG_MODULES

``` bash
$ cat /boot/config-$(uname -r) | grep CONFIG_MODULES
CONFIG_MODULES_USE_ELF_RELA=y
CONFIG_MODULES=y
CONFIG_MODULES_TREE_LOOKUP=y
```

### Tipos de modulos 
1. In-Source Tree: Modulos incluidos en el codigo fuente del Kernel de Linux
                   Se encuentran en /lib/modules/{kernel_version}/kernel
2. Out-of-Tree: Modulos no incluidos en el codigo fuente del Kernel de Linux

### Listado de modulos cargados (lsmod)
``` bash
$ lsmod
Module                  Size  Used by
tls                   155648  0
stp                    12288  1 bridge
...
nft_compat             20480  6
nf_tables             376832  71 nft_compat,nft_chain_nat
```

### Informacion del modulo cargados (modinfo)
``` bash
$ modinfo nft_compat$ modinfo nft_compat
filename:       /lib/modules/6.8.0-83-generic/kernel/net/netfilter/nft_compat.ko
description:    x_tables over nftables support
alias:          nft-expr-target
alias:          nft-expr-match
author:         Pablo Neira Ayuso <pablo@netfilter.org>
license:        GPL
alias:          nfnetlink-subsys-11
srcversion:     D3B2421CDBEE29B16EECA34
depends:        nfnetlink,x_tables,nf_tables
retpoline:      Y
intree:         Y
name:           nft_compat
vermagic:       6.8.0-83-generic SMP preempt mod_unload modversions 
sig_id:         PKCS#7
signer:         Build time autogenerated kernel key
sig_key:        XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX
sig_hashalgo:   sha512
signature:      XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX

```

### Compilando un modulo desde shell
Desde el directorio donde esta module.c
``` bash
make -C /lib/modules/`uname -r`/build M=${PWD} modules
```

### Limpiando el compilado desde shell
Desde el directorio donde esta module.c
``` bash
make -C /lib/modules/`uname -r`/build M=${PWD} clean
```

### Makefile basico
``` bash
obj-m = module_name.o
module_name-objs := file1.o file2.o

all:
	make -C /lib/modules/$(shell uname -r)/build M=$(PWD) modules
clean:
	make -C /lib/modules/$(shell uname -r)/build M=$(PWD) clean
```

### Informacion del modulo compilado (modinfo)
``` bash
$ modinfo ./test_module.ko
filename:       /path/to/module/test_module.ko
license:        GPL
srcversion:     93D66C3F0AA4FDD8C22B72B
depends:        
retpoline:      Y
name:           test_module
vermagic:       6.8.0-83-generic SMP preempt mod_unload modversions 
```

### Cargar el modulo (insmod)
``` bash
$ sudo insmod ./test_module.ko
```

### Cargar el modulo y dependencias (modprobe)
``` bash
$ sudo modprobe test_module.ko
```
solo funciona con modulos que esten en /lib/modules/{kernel_version}/

### Generacion de dependencias entre modulos (depmod)
depmod calcula las dependencias de todos los módulos presentes en la carpeta "/lib/modules/{kernel_version}/", y coloca la información de dependencias en el archivo "/lib/modules/{kernel_version}/modules.dep"

``` bash
$ sudo depmod -a
$ cat /lib/modules/$(uname -r)/modules.dep
...
kernel/arch/x86/kernel/cpuid.ko:
kernel/arch/x86/crypto/twofish-x86_64.ko: kernel/crypto/twofish_common.ko
kernel/arch/x86/crypto/twofish-x86_64-3way.ko: kernel/arch/x86/crypto/twofish-x86_64.ko kernel/crypto/twofish_common.ko
...
```
* cpuid.ko no tiene dependencias
* twofish-x86_64.ko tiene una dependencia
* twofish-x86_64-3way.ko tiene dos dependencias

### Eliminar el modulo
``` bash
$ sudo rmmod ./test_module.ko
```

### Estructura basica 
```c
#include <linux/kernel.h>
#include <linux/module.h>

char *modname = __stringify(KBUILD_MODNAME);
MODULE_LICENSE("GPL");

static int new_module_init(void)
{
    printk("%s: Module Name:%s Loaded\n", __func__, modname);
    ...
    return 0;
}
module_init(new_module_init);

static void new_module_exit(void)
{
    printk("%s: Module Name:%s Removed\n", __func__, modname);
    ...
}
module_exit(new_module_exit);

MODULE_AUTHOR("AMR");
MODULE_DESCRIPTION("Descripcion del modulo");
```

### Macros de metadatos
```c
MODULE_LICENSE("GPL");
MODULE_AUTHOR("Antonio Morales <antonio1010.mr@gmail.com>");
MODULE_DESCRIPTION("Driver de ejemplo para ...");
MODULE_VERSION("1.0");
MODULE_ALIAS("gpio_led_driver");					// Define alias para autoload con modprobe
```
Estos metadatos se pueden visualizar con `modinfo`

### Paso de parametros al modulo (module_param(...))
Es posible pasarle parametros al modulo cuando se carga con `insmod` o `modprobe` y de esta forma
cambiar el comportamiento del modulo sin recompilarlo
	* Definir direcciones IO en el momento de la carga del modulo
    * Habilitar/desabilitar debu logs/printk
    * Ajustar el modo de funcionamiento si el driver soporta distintos modos

#### Sintaxis general
```c
module_param(nombre, tipo, permisos);
```

#### Tipos de datos para parametros
* int: número entero.
* long: número largo.
* short: número corto.
* uint: entero sin signo.
* ulong: entero largo sin signo.
* bool: acepta 0/1, y/n, true/false al pasar el parámetro.
* charp: puntero a cadena (string, tipo char *).
* invbool: como bool, pero invierte el valor (true → false).

#### Permisos
* 0444	Solo lectura para todos
* 0644	Lectura todos, escritura root (más usado)
* 0600	Lectura/escritura solo root
* 0666	Lectura/escritura todos (no recomendable)
* 0		No expone el parámetro en sysfs
* S_IRUGO → “readable by user, group, others” (equivalente a 0444)
* S_IWUSR → “writable by user” (equivalente a 0200)
* S_IRUSR → “readable by user” (equivalente a 0400)

#### Ejemplo
```c
...
#include <linux/moduleparam.h>

// Valores por defecto para los parametros
static int myint = 42;
static char *mystring = "default";
static bool myflag = false;

// Declaracion del parametro y su descripcion
module_param(myint, int, 0644);
MODULE_PARM_DESC(myint, "Un entero de ejemplo");

module_param(mystring, charp, 0644);
MODULE_PARM_DESC(mystring, "Una cadena de ejemplo");

module_param(myflag, bool, 0644);
MODULE_PARM_DESC(myflag, "Un booleano de ejemplo");
...
MODULE_LICENSE("GPL");
MODULE_AUTHOR("AMR");
MODULE_DESCRIPTION("Ejemplo de paso de parámetros");

```

#### Arrays de datos como parametros (module_param_array(...))
```c
module_param_array(nombre, tipo, numerop, permisos);
```
`numerop` puede ser NULL si no se quiere recibir el numero de parametros.

```c
#include <linux/moduleparam.h>

#define MAX_ARRAY 5

static int myarray[MAX_ARRAY];
static int arr_argc = 0;   // aquí se guarda cuántos elementos pasan

module_param_array(myarray, int, &arr_argc, 0444);
MODULE_PARM_DESC(myarray, "Un array de enteros");
```
Si se pasan menos parametros de MAX_ARRAY se rellenaran a 0. Si se pasan mas, dara error al insertar el modulo.

#### Arrays de datos como parametros (module_param_array_named(...))
```c
module_param_array(nombre, tipo, numerop, permisos);
```

#### Consulta de los parametros de un modulo
```bash
$ modinfo modulo.ko
filename:       /path/to/modulo/modulo.ko
description:    Ejemplo de paso de parámetros
author:         AMR
...
vermagic:       6.8.0-83-generic SMP preempt mod_unload modversions 
parm:           myint:Un entero de ejemplo (int)
parm:           mystring:Una cadena de ejemplo (charp)
parm:           myflag:Un booleano de ejemplo (bool)
```

#### Pasar parametros durante la carga
Cuiado con los string que contengan espacios. Añadir commillas simples a la cadena
```bash
$ sudo insmod ./modulo.ko myint=5 mystring="HELLO"
$ sudo insmod ./modulo.ko mystring='"HELLO WORLD"'
$ sudo insmod ./modulo.ko myarray=1,2,3,4
```

#### Visualizacion en el FS (si los permisos son distintos de 0)
```c
$ /sys/module/{my_module}/parameters/{my_parameter}
```

### Proceso de compilado del modulo
```
             ┌────────────────┐
             │   modulo.c     │   (código fuente)
             └───────┬────────┘
                     │
                     ▼
             ┌────────────────┐
             │   modulo.o     │   (objeto intermedio)
             └───────┬────────┘
                     │
        ┌────────────┴───────────────┐
        │                            │
        ▼                            ▼
┌────────────────┐          ┌───────────────────┐
│ modulo.mod.c   │ (autogen)│  modules.order    │ (lista de módulos)
└───────┬────────┘          └───────────────────┘
        │
        ▼
┌────────────────┐
│ modulo.mod.o   │   (objeto con info del módulo)
└───────┬────────┘
        │
        ▼
┌────────────────┐
│  modulo.ko     │   (módulo final, cargable en kernel)
└────────────────┘


Otros ficheros auxiliares:
──────────────────────────
- Module.symvers   : símbolos exportados/importados
- modulo.mod       : dependencias del módulo
- .modulo.ko.cmd   : receta de compilación
```


## SIMBOLOS (SYMBOL)
Un simbolo es cualquier funcion o variable definida en el modulo

### Symbol Table
- Estructura de datos creada por el compilador que contiene todos los símbolos utilizados en el programa.
- Cada imagen del kernel que compilas incluye una tabla de símbolos.
- La tabla de símbolos del kernel de Linux contiene los nombres y direcciones de todos los símbolos del kernel.
- Cuando instalas el kernel, estará presente en `/boot/System.map-<linux_version>`
- Los simbolos de los modulos out the tree se encuentran en `/proc/kallsyms`

```bash
$ sudo cat /boot/System.map-$(uname -r)
...
ffffffff83f90c90 b pci_mmcfg_arch_init_failed
ffffffff83f90c91 b pci_mmcfg_running_state
ffffffff83f90c98 B xen_pci_frontend
ffffffff83f90ca0 b l1ss_header
ffffffff83f90ca4 b prev_header
...
```
- Direccion virtual del simbolo memoria
- Tipo de simbolo:
- T → símbolo global en text section (código, función exportada).
    - t: símbolo local en text section.
    - D: símbolo global en data section (variable global).
    - d: símbolo local en data section.
    - R: símbolo global en read-only data.
    - r: símbolo local en read-only data.
    - B: símbolo en BSS section (variables no inicializadas).
    - b: lo mismo pero local.
    - V: variable (global, exportada).
    - v: variable local.
    - W: símbolo débil global (puede ser sobrescrito por otro de mayor prioridad).
    - w: simbolo debil local.
    - A: símbolo absoluto (no cambia de dirección aunque se reubique). absoluto (no cambia de dirección aunque se reubique).
    - a: simbolo absoluto local.
    - ?: símbolo desconocido.
- nombre del simbolo

```bash
$ awk '{print $2}' /proc/kallsyms | sort | uniq -c | sort -nr
 132499 t
  63590 T
  46507 d
  38084 r
   4234 b
   4202 D
    850 B
    400 A
    316 W
     63 R
     12 a
      4 w
      1 V
```

```bash
$ sudo awk '{print $2}' /boot/System.map-$(uname -r) | sort | uniq -c | sort -nr
  77187 t
  61964 T
  37664 d
  14928 r
   4288 D
   3534 b
    838 B
    316 W
     55 R
      4 A
      1 V
```

### Exportar Symbols
Cualquier funcion o variable definida en un modulo tiene caracter local por defecto.

Para exportar esta función y permitir que otros módulos la utilicen, es necesario usar las macros:
  * EXPORT_SYMBOL(...): Exporta el simbolo para ser usado por cualquier modulo del kernel.
  * EXPORT_SYMBOL_GPL(...): Exporta el simbolo para ser usado solamente por modulos del kernel con licencia GPL

Una vez exportadas, estarán disponibles para que otros módulos las usen.

### Extra symbols
A veces, un módulo externo utiliza símbolos exportados desde otro módulo externo.

kbuild necesita tener conocimiento completo de todos los símbolos para evitar mostrar advertencias sobre símbolos indefinidos.

Cuando se compila un módulo externo, se genera un archivo Module.symvers que contiene todos los símbolos exportados que no están definidos en el kernel.

Utiliza KBUILD_EXTRA_SYMBOLS y proporciona la ruta al archivo Module.symvers si este se encuentra en un directorio diferente al del módulo.

```Makefile
obj-m := my_modulo.o

KBUILD_EXTRA_SYMBOLS := /path/to/imported/module/Module.symvers
```
### Examinar las secciones de un modulo
```shell
$ objdump --section-headers ./mod_info.ko
./mod_info.ko:     formato del fichero elf64-x86-64

Secciones:
Idx Name          Size      VMA               LMA               File off  Algn
  0 .note.gnu.build-id 00000024  0000000000000000  0000000000000000  00000040  2**2
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
  1 .note.Linux   00000030  0000000000000000  0000000000000000  00000064  2**2
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
  2 .text         00000000  0000000000000000  0000000000000000  00000094  2**0
                  CONTENTS, ALLOC, LOAD, READONLY, CODE
  3 .exit.text    00000015  0000000000000000  0000000000000000  000000a0  2**4
                  CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE
  4 .init.text    0000004b  0000000000000000  0000000000000000  000000c0  2**4
                  CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE
  5 .rodata.str1.1 0000001d  0000000000000000  0000000000000000  0000010b  2**0
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
  6 __mcount_loc  00000008  0000000000000000  0000000000000000  00000128  2**0
                  CONTENTS, ALLOC, LOAD, RELOC, READONLY, DATA
  7 .modinfo      000000b3  0000000000000000  0000000000000000  00000130  2**0
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
  8 .return_sites 00000008  0000000000000000  0000000000000000  000001e3  2**0
                  CONTENTS, ALLOC, LOAD, RELOC, READONLY, DATA
...
```

### Examinar el contenido de una seccion
```bash
$ objdump --section-headers --section=.modinfo --full-contents ./mod_info.ko

./mod_info.ko:     formato del fichero elf64-x86-64

Secciones:
Idx Name          Size      VMA               LMA               File off  Algn
  7 .modinfo      000000b3  0000000000000000  0000000000000000  00000130  2**0
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
Contenido de la sección .modinfo:
 0000 6c696365 6e73653d 47504c00 76657273  license=GPL.vers
 0010 696f6e3d 312e3000 4f533d4c 696e7578  ion=1.0.OS=Linux
 0020 006e616d 653d456d 62656464 65640073  .name=Embedded.s
 0030 72637665 7273696f 6e3d3037 33433245  rcversion=073C2E
 0040 46363642 36453132 45433942 46363646  F66B6E12EC9BF66F
 0050 34006465 70656e64 733d0072 6574706f  4.depends=.retpo
 0060 6c696e65 3d59006e 616d653d 6d6f645f  line=Y.name=mod_
 0070 696e666f 00766572 6d616769 633d362e  info.vermagic=6.
 0080 382e302d 38332d67 656e6572 69632053  8.0-83-generic S
 0090 4d502070 7265656d 7074206d 6f645f75  MP preempt mod_u
 00a0 6e6c6f61 64206d6f 64766572 73696f6e  nload modversion
 00b0 732000                               s .             
```

## LOGS

### El buffer circular de mensajes del kernel (dmesg)

#### Ver mensajes
```c
$ sudo dmesg
```
#### Borrar el buffer
Borrarlo tras representarlo
```c
$ sudo dmesg -c
```

#### Borrarlo sin representarlo
```c
$ sudo dmesg -C
```

#### No imprimir timestamps
```c
$ sudo dmesg -t
```

#### Imprimir timestamps human ready
```c
$ sudo dmesg -T
```

#### Imprimir solo mensajes con cierto nivel de prioridad
```c
$ sudo dmesg -l err,warn
```

#### Imprimir prioridad de los mensajes al inicio del mensaje
```c
$ sudo dmesg -x
```

### Tamaño del log
- Definido en make menuconfig -> General Setup -> Kernel log buffer size
- size __LOG_BUF_LEN bytes where __LOG_BUF_LEN equals (1 << CONFIG_LOG_BUF_SHIFT).
```bash
$ cat /boot/config-`uname -r` | grep CONFIG_LOG_BUF_SHIFT
CONFIG_LOG_BUF_SHIFT=18
```
- dmesg reads by default a buffer of max 16392 bytes, so if you use a larger logbuffer you have to invoke dmesg with the -s parameter

### Memory dumps

#### Volcado del stack
```c
static int myinit(void)
{
	pr_info("dump_stack myinit\n");
	dump_stack();
	pr_info("dump_stack after\n");
	return 0;
}
```
```bash
$ sudo dmesg
...
[11528.715980] dump_stack myinit
[11528.715987] CPU: 3 PID: 52913 Comm: insmod Tainted: G           OE      6.8.0-83-generic #83~22.04.1-Ubuntu
[11528.715993] Hardware name: ENZ C16B/C16B, BIOS c 11/21/2014
[11528.715996] Call Trace:
[11528.715999]  <TASK>
[11528.716002]  dump_stack_lvl+0x76/0xa0
[11528.716012]  ? __pfx_myinit+0x10/0x10 [dump_stack]
[11528.716017]  dump_stack+0x10/0x20
[11528.716022]  myinit+0x1a/0xfc0 [dump_stack]
[11528.716026]  do_one_initcall+0x5e/0x340
[11528.716036]  do_init_module+0x97/0x290
[11528.716043]  load_module+0xb85/0xcd0
[11528.716048]  ? security_kernel_post_read_file+0x75/0x90
[11528.716056]  init_module_from_file+0x96/0x100
[11528.716060]  ? init_module_from_file+0x96/0x100
[11528.716066]  idempotent_init_module+0x11c/0x310
[11528.716071]  __x64_sys_finit_module+0x64/0xd0
[11528.716075]  x64_sys_call+0x15ed/0x2480
[11528.716079]  do_syscall_64+0x81/0x170
[11528.716084]  ? ksys_mmap_pgoff+0x120/0x270
[11528.716088]  ? syscall_exit_to_user_mode+0x83/0x260
[11528.716092]  ? do_syscall_64+0x8d/0x170
[11528.716096]  ? ksys_read+0x73/0x100
[11528.716100]  ? generic_fillattr+0x4a/0x160
[11528.716103]  ? _copy_to_user+0x25/0x50
[11528.716107]  ? cp_new_stat+0x143/0x180
[11528.716111]  ? __do_sys_newfstatat+0x53/0x90
[11528.716115]  ? syscall_exit_to_user_mode+0x83/0x260
[11528.716119]  ? do_syscall_64+0x8d/0x170
[11528.716123]  ? irqentry_exit+0x43/0x50
[11528.716126]  ? exc_page_fault+0x94/0x1b0
[11528.716129]  entry_SYSCALL_64_after_hwframe+0x78/0x80
[11528.716133] RIP: 0033:0x79d21251e8fd
[11528.716145] Code: 5b 41 5c c3 66 0f 1f 84 00 00 00 00 00 f3 0f 1e fa 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d 03 b5 0f 00 f7 d8 64 89 01 48
[11528.716148] RSP: 002b:00007ffff75c4cf8 EFLAGS: 00000246 ORIG_RAX: 0000000000000139
[11528.716151] RAX: ffffffffffffffda RBX: 0000642a4e29d780 RCX: 000079d21251e8fd
[11528.716153] RDX: 0000000000000000 RSI: 0000642a39c08cd2 RDI: 0000000000000003
[11528.716155] RBP: 0000000000000000 R08: 0000000000000000 R09: 0000000000000000
[11528.716156] R10: 0000000000000003 R11: 0000000000000246 R12: 0000642a39c08cd2
[11528.716159] R13: 0000642a4e2a16f0 R14: 0000642a39c07888 R15: 0000642a4e29d890
[11528.716162]  </TASK>
[11528.716163] dump_stack after
```

### Mensajes Oops
Un OOPS es similar a un "segfault" en espacio de usuario. El kernel lanza un mensaje OOPS cuando ocurre una excepción, como acceder a una ubicación de memoria inválida en el código del kernel.

Cuando ocurre un OOPS, el kernel realiza las siguientes operaciones:
- Mata el proceso que causó el error
- Imprime información útil para que los desarrolladores puedan depurar
- Continúa la ejecución.
    Nota: Después de un OOPS, el sistema no puede considerarse confiable, ya que algunos locks o estructuras pueden no haberse limpiado correctamente.

Un mensaje OOPS contiene la siguiente información:
- Estado del procesador
- Contenido de los registros de la CPU en el momento de la excepción
- Stack trace (traza de pila)
- Call Trace (traza de llamadas)

```c
...
static int test_oops_init(void)
{
    printk(KERN_INFO"%s: In init\n", __func__);
	//we are trying to access invalid memory location
    *(int *)0x12 = 'a';
    return 0;
}
...
```
```shell
$ $ sudo insmod oops_test.ko
Terminado (killed)

$ sudo dmesg
...
[12192.266816] test_oops_init: In init
[12192.266822] BUG: kernel NULL pointer dereference, address: 0000000000000012
[12192.266826] #PF: supervisor write access in kernel mode
[12192.266828] #PF: error_code(0x0002) - not-present page
[12192.266830] PGD 0 P4D 0 
[12192.266833] Oops: 0002 [#1] PREEMPT SMP PTI
[12192.266836] CPU: 3 PID: 56664 Comm: insmod Tainted: G           OE      6.8.0-83-generic #83~22.04.1-Ubuntu
[12192.266838] Hardware name: ENZ C16B/C16B, BIOS c 11/21/2014
[12192.266840] RIP: 0010:test_oops_init+0x1e/0x40 [oops_test]
[12192.266844] Code: 90 90 90 90 90 90 90 90 90 90 90 90 0f 1f 44 00 00 55 48 c7 c6 98 90 a3 c1 48 c7 c7 54 90 a3 c1 48 89 e5 e8 64 d4 d7 e7 31 c0 <c7> 04 25 12 00 00 00 61 00 00 00 5d 31 f6 31 ff c3 cc cc cc cc 66
[12192.266846] RSP: 0018:ffff98ee859139e0 EFLAGS: 00010246
[12192.266848] RAX: 0000000000000000 RBX: ffffffffc1a35010 RCX: 0000000000000000
[12192.266850] RDX: 0000000000000000 RSI: 0000000000000000 RDI: 0000000000000000
[12192.266851] RBP: ffff98ee859139e0 R08: 0000000000000000 R09: 0000000000000000
[12192.266852] R10: 0000000000000000 R11: 0000000000000000 R12: 0000000000000000
[12192.266854] R13: 0000000000000000 R14: ffff98ee859139f0 R15: 0000000000000000
[12192.266855] FS:  000078ad087d4c40(0000) GS:ffff88e056d80000(0000) knlGS:0000000000000000
[12192.266857] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[12192.266859] CR2: 0000000000000012 CR3: 000000010ac4e003 CR4: 00000000003706f0
[12192.266861] Call Trace:
[12192.266862]  <TASK>
[12192.266865]  ? show_regs+0x6d/0x80
[12192.266869]  ? __die+0x24/0x80
[12192.266872]  ? page_fault_oops+0x99/0x1b0
[12192.266877]  ? do_user_addr_fault+0x2f5/0x680
[12192.266880]  ? exc_page_fault+0x83/0x1b0
[12192.266884]  ? asm_exc_page_fault+0x27/0x30
[12192.266888]  ? __pfx_test_oops_init+0x10/0x10 [oops_test]
[12192.266891]  ? test_oops_init+0x1e/0x40 [oops_test]
[12192.266893]  do_one_initcall+0x5e/0x340
[12192.266898]  do_init_module+0x97/0x290
[12192.266902]  load_module+0xb85/0xcd0
[12192.266905]  ? security_kernel_post_read_file+0x75/0x90
[12192.266910]  init_module_from_file+0x96/0x100
[12192.266913]  ? init_module_from_file+0x96/0x100
[12192.266916]  idempotent_init_module+0x11c/0x310
[12192.266919]  __x64_sys_finit_module+0x64/0xd0
[12192.266922]  x64_sys_call+0x15ed/0x2480
[12192.266924]  do_syscall_64+0x81/0x170
[12192.266927]  ? syscall_exit_to_user_mode+0x83/0x260
[12192.266931]  ? do_syscall_64+0x8d/0x170
[12192.266934]  ? ksys_read+0x73/0x100
[12192.266937]  ? syscall_exit_to_user_mode+0x83/0x260
[12192.266940]  ? do_syscall_64+0x8d/0x170
[12192.266943]  ? __x64_sys_openat+0x6c/0xa0
[12192.266946]  ? syscall_exit_to_user_mode+0x83/0x260
[12192.266949]  ? do_syscall_64+0x8d/0x170
[12192.266952]  ? syscall_exit_to_user_mode+0x83/0x260
[12192.266955]  ? do_syscall_64+0x8d/0x170
[12192.266958]  ? handle_mm_fault+0xad/0x380
[12192.266960]  ? do_user_addr_fault+0x33f/0x680
[12192.266963]  ? irqentry_exit_to_user_mode+0x78/0x260
[12192.266967]  ? irqentry_exit+0x43/0x50
[12192.266969]  ? exc_page_fault+0x94/0x1b0
[12192.266973]  entry_SYSCALL_64_after_hwframe+0x78/0x80
[12192.266975] RIP: 0033:0x78ad07f1e8fd
[12192.266986] Code: 5b 41 5c c3 66 0f 1f 84 00 00 00 00 00 f3 0f 1e fa 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d 03 b5 0f 00 f7 d8 64 89 01 48
[12192.266988] RSP: 002b:00007ffcde3a0b38 EFLAGS: 00000246 ORIG_RAX: 0000000000000139
[12192.266990] RAX: ffffffffffffffda RBX: 000055c303ff3780 RCX: 000078ad07f1e8fd
[12192.266992] RDX: 0000000000000000 RSI: 000055c2d58e7cd2 RDI: 0000000000000003
[12192.266993] RBP: 0000000000000000 R08: 0000000000000000 R09: 0000000000000000
[12192.266994] R10: 0000000000000003 R11: 0000000000000246 R12: 000055c2d58e7cd2
[12192.266996] R13: 000055c303ff76f0 R14: 000055c2d58e6888 R15: 000055c303ff3890
[12192.266998]  </TASK>
[12192.267000] Modules linked in: oops_test(OE+) tls xt_conntrack xt_MASQUERADE bridge stp llc xt_set ip_set nft_chain_nat nf_nat nf_conntrack nf_defrag_ipv6 nf_defrag_ipv4 xt_addrtype nft_compat nf_tables libcrc32c nfnetlink xfrm_user xfrm_algo ccm rfcomm vboxnetadp(OE) vboxnetflt(OE) vboxdrv(OE) cmac algif_hash algif_skcipher af_alg bnep overlay snd_hda_codec_realtek snd_hda_codec_generic intel_rapl_msr snd_hda_codec_hdmi uvcvideo snd_hda_intel videobuf2_vmalloc intel_rapl_common uvc x86_pkg_temp_thermal snd_intel_dspcfg intel_powerclamp snd_intel_sdw_acpi coretemp snd_hda_codec videobuf2_memops kvm_intel videobuf2_v4l2 snd_hda_core snd_hwdep mei_hdcp mei_pxp videodev btusb binfmt_misc kvm snd_pcm iwlmvm irqbypass btrtl mac80211 btintel btbcm videobuf2_common btmtk snd_seq_midi joydev snd_seq_midi_event rapl mc intel_cstate libarc4 bluetooth snd_rawmidi snd_seq iwlwifi ecdh_generic snd_seq_device snd_timer ecc input_leds cmdlinepart serio_raw spi_nor snd cfg80211 mtd at24 mei_me mei soundcore intel_pch_thermal
[12192.267062]  soc_button_array mac_hid acpi_pad sch_fq_codel msr parport_pc ppdev lp parport efi_pstore ip_tables x_tables autofs4 hid_logitech_hidpp hid_logitech_dj hid_generic usbhid hid crct10dif_pclmul spi_intel_platform spi_intel i915 crc32_pclmul polyval_clmulni polyval_generic ghash_clmulni_intel sha256_ssse3 sha1_ssse3 drm_buddy i2c_algo_bit ttm r8169 ahci drm_display_helper psmouse realtek libahci i2c_i801 cec xhci_pci xhci_pci_renesas i2c_smbus lpc_ich rc_core video wmi aesni_intel crypto_simd cryptd [last unloaded: dump_stack(OE)]
[12192.267095] CR2: 0000000000000012
[12192.267097] ---[ end trace 0000000000000000 ]---
[12192.267107] RIP: 0010:test_oops_init+0x1e/0x40 [oops_test]
[12192.267110] Code: 90 90 90 90 90 90 90 90 90 90 90 90 0f 1f 44 00 00 55 48 c7 c6 98 90 a3 c1 48 c7 c7 54 90 a3 c1 48 89 e5 e8 64 d4 d7 e7 31 c0 <c7> 04 25 12 00 00 00 61 00 00 00 5d 31 f6 31 ff c3 cc cc cc cc 66
[12192.267112] RSP: 0018:ffff98ee859139e0 EFLAGS: 00010246
[12192.267114] RAX: 0000000000000000 RBX: ffffffffc1a35010 RCX: 0000000000000000
[12192.267115] RDX: 0000000000000000 RSI: 0000000000000000 RDI: 0000000000000000
[12192.267126] RBP: ffff98ee859139e0 R08: 0000000000000000 R09: 0000000000000000
[12192.267127] R10: 0000000000000000 R11: 0000000000000000 R12: 0000000000000000
[12192.267129] R13: 0000000000000000 R14: ffff98ee859139f0 R15: 0000000000000000
[12192.267130] FS:  000078ad087d4c40(0000) GS:ffff88e056d80000(0000) knlGS:0000000000000000
[12192.267132] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[12192.267133] CR2: 0000000000000012 CR3: 000000010ac4e003 CR4: 00000000003706f0
[12192.267135] note: insmod[56664] exited with irqs disabled
```

### Volcados condicionales

#### BUG() o BUG_ON(condition)
- Imprime el contenido de los registros
- Imprime la traza de la pila (Stack Trace)
- El proceso actual muere
```c
    switch (clk) {
        case CLOCK_REALTIME:
                name = "realtime\n";**
                sz = sizeof("realtime\n");
                break;
        case CLOCK_MONOTONIC:
                name = "monotonic\n";
                sz = sizeof("monotonic\n");
                break;
        ...

        default:
                BUG();
```

#### WARN() o WARN_ON(condition)
- Imprime el contenido de los registros
- Imprime la traza de la pila (Stack Trace)
```c
    case IIO_VAL_FRACTIONAL:
        WARN_ON(attr->vals[i * 2] > 4294);
        tbl_val = attr->vals[i * 2] * 1000000 /
        attr->vals[i * 2 + 1];
        break;
```
## THREADS
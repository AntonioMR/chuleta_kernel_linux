# Linux Kernel Programming Cheatsheet

## MODULOS

### Configuracion
El kernel tiene que estar compilado con la opcion CONFIG_MODULES

``` shell
$ cat /boot/config-$(uname -r) | grep CONFIG_MODULES
CONFIG_MODULES_USE_ELF_RELA=y
CONFIG_MODULES=y
CONFIG_MODULES_TREE_LOOKUP=y
```

### Tipos de modulos 
1. In-Source Tree: Modulos incluidos en el codigo fuente del Kernel de Linux
                   Se encuentran en /lib/modules/{kernel_version}/kernel
2. Out-of-Tree: Modulos no incluidos en el codigo fuente del Kernel de Linux

### Listado de modulos cargados (lsmod)
``` shell
$ lsmod
Module                  Size  Used by
tls                   155648  0
stp                    12288  1 bridge
...
nft_compat             20480  6
nf_tables             376832  71 nft_compat,nft_chain_nat
```

### Informacion del modulo cargados (modinfo)
``` shell
$ modinfo nft_compat$ modinfo nft_compat
filename:       /lib/modules/6.8.0-83-generic/kernel/net/netfilter/nft_compat.ko
description:    x_tables over nftables support
alias:          nft-expr-target
alias:          nft-expr-match
author:         Pablo Neira Ayuso <pablo@netfilter.org>
license:        GPL
alias:          nfnetlink-subsys-11
srcversion:     D3B2421CDBEE29B16EECA34
depends:        nfnetlink,x_tables,nf_tables
retpoline:      Y
intree:         Y
name:           nft_compat
vermagic:       6.8.0-83-generic SMP preempt mod_unload modversions 
sig_id:         PKCS#7
signer:         Build time autogenerated kernel key
sig_key:        XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX
sig_hashalgo:   sha512
signature:      XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX

```

### Compilando un modulo desde shell
Desde el directorio donde esta module.c
``` shell
make -C /lib/modules/`uname -r`/build M=${PWD} modules
```

### Limpiando el compilado desde shell
Desde el directorio donde esta module.c
``` shell
make -C /lib/modules/`uname -r`/build M=${PWD} clean
```

### Makefile basico
``` shell
`obj-m += module_name.o

all:
	make -C /lib/modules/$(shell uname -r)/build M=$(PWD) modules
clean:
	make -C /lib/modules/$(shell uname -r)/build M=$(PWD) clean
```

### Informacion del modulo compilado (modinfo)
``` shell
$ modinfo ./test_module.ko
filename:       /path/to/module/test_module.ko
license:        GPL
srcversion:     93D66C3F0AA4FDD8C22B72B
depends:        
retpoline:      Y
name:           test_module
vermagic:       6.8.0-83-generic SMP preempt mod_unload modversions 
```

### Cargar el modulo (insmod)
``` shell
$ sudo insmod ./test_module.ko
```

### Cargar el modulo y dependencias (modprobe)
``` shell
$ sudo modprobe test_module.ko
```
solo funciona con modulos que esten en /lib/modules/{kernel_version}/

### Generacion de dependencias entre modulos (depmod)
depmod calcula las dependencias de todos los módulos presentes en la carpeta "/lib/modules/{kernel_version}/", y coloca la información de dependencias en el archivo "/lib/modules/{kernel_version}/modules.dep"

``` shell
$ sudo depmod -a
$ cat /lib/modules/$(uname -r)/modules.dep
...
kernel/arch/x86/kernel/cpuid.ko:
kernel/arch/x86/crypto/twofish-x86_64.ko: kernel/crypto/twofish_common.ko
kernel/arch/x86/crypto/twofish-x86_64-3way.ko: kernel/arch/x86/crypto/twofish-x86_64.ko kernel/crypto/twofish_common.ko
...
```
* cpuid.ko no tiene dependencias
* twofish-x86_64.ko tiene una dependencia
* twofish-x86_64-3way.ko tiene dos dependencias

### Eliminar el modulo
``` shell
$ sudo rmmod ./test_module.ko
```

### Estructura basica 
```c
#include <linux/kernel.h>
#include <linux/module.h>

MODULE_LICENSE("GPL");

static int new_module_init(void)
{
    ...
    return 0;
}
module_init(new_module_init);

static void new_module_exit(void)
{
    ...
}
module_exit(new_module_exit);

MODULE_AUTHOR("AMR");
MODULE_DESCRIPTION("Descripcion del modulo");
```

### Macros de metadatos
```c
MODULE_LICENSE("GPL");
MODULE_AUTHOR("Antonio Morales <antonio1010.mr@gmail.com>");
MODULE_DESCRIPTION("Driver de ejemplo para ...");
MODULE_VERSION("1.0");
MODULE_ALIAS("gpio_led_driver");					// Define alias para autoload con modprobe
```
Estos metadatos se pueden visualizar con `modinfo`

### Paso de parametros al modulo (module_param(...))
Es posible pasarle parametros al modulo cuando se carga con `insmod` o `modprobe` y de esta forma
cambiar el comportamiento del modulo sin recompilarlo
	* Definir direcciones IO en el momento de la carga del modulo
    * Habilitar/desabilitar debu logs/printk
    * Ajustar el modo de funcionamiento si el driver soporta distintos modos

#### Sintaxis general
```c
module_param(nombre, tipo, permisos);
```

#### Tipos de datos para parametros
* int: número entero.
* long: número largo.
* short: número corto.
* uint: entero sin signo.
* ulong: entero largo sin signo.
* bool: acepta 0/1, y/n, true/false al pasar el parámetro.
* charp: puntero a cadena (string, tipo char *).
* invbool: como bool, pero invierte el valor (true → false).

#### Permisos
* 0444	Solo lectura para todos
* 0644	Lectura todos, escritura root (más usado)
* 0600	Lectura/escritura solo root
* 0666	Lectura/escritura todos (no recomendable)
* 0		No expone el parámetro en sysfs
* S_IRUGO → “readable by user, group, others” (equivalente a 0444)
* S_IWUSR → “writable by user” (equivalente a 0200)
* S_IRUSR → “readable by user” (equivalente a 0400)

#### Ejemplo
```c
...
#include <linux/moduleparam.h>

// Valores por defecto para los parametros
static int myint = 42;
static char *mystring = "default";
static bool myflag = false;

// Declaracion del parametro y su descripcion
module_param(myint, int, 0644);
MODULE_PARM_DESC(myint, "Un entero de ejemplo");

module_param(mystring, charp, 0644);
MODULE_PARM_DESC(mystring, "Una cadena de ejemplo");

module_param(myflag, bool, 0644);
MODULE_PARM_DESC(myflag, "Un booleano de ejemplo");
...
MODULE_LICENSE("GPL");
MODULE_AUTHOR("AMR");
MODULE_DESCRIPTION("Ejemplo de paso de parámetros");

```

#### Arrays de datos como parametros (module_param_array(...))
```c
module_param_array(nombre, tipo, numerop, permisos);
```
`numerop` puede ser NULL si no se quiere recibir el numero de parametros.

```c
#include <linux/moduleparam.h>

#define MAX_ARRAY 5

static int myarray[MAX_ARRAY];
static int arr_argc = 0;   // aquí se guarda cuántos elementos pasan

module_param_array(myarray, int, &arr_argc, 0444);
MODULE_PARM_DESC(myarray, "Un array de enteros");
```
Si se pasan menos parametros de MAX_ARRAY se rellenaran a 0. Si se pasan mas, dara error al insertar el modulo.

#### Arrays de datos como parametros (module_param_array_named(...))
```c
module_param_array(nombre, tipo, numerop, permisos);
```

#### Consulta de los parametros de un modulo
```c
$ modinfo modulo.ko
filename:       /path/to/modulo/modulo.ko
description:    Ejemplo de paso de parámetros
author:         AMR
...
vermagic:       6.8.0-83-generic SMP preempt mod_unload modversions 
parm:           myint:Un entero de ejemplo (int)
parm:           mystring:Una cadena de ejemplo (charp)
parm:           myflag:Un booleano de ejemplo (bool)
```

#### Pasar parametros durante la carga
Cuiado con los string que contengan espacios. Añadir commillas simples a la cadena
```c
$ sudo insmod ./modulo.ko myint=5 mystring="HELLO"
$ sudo insmod ./modulo.ko mystring='"HELLO WORLD"'
$ sudo insmod ./modulo.ko myarray=1,2,3,4
```

#### Visualizacion en el FS (si los permisos son distintos de 0)
```c
$ /sys/module/{my_module}/parameters/{my_parameter}
```

## SYMBOLOS
Un simbolo es cualquier funcion o variable definida en el modulo

## LOGS

### El buffer circular de mensajes del kernel (dmesg)

#### Ver mensajes
```c
$ sudo dmesg
```
#### Borrar el buffer
Borrarlo tras representarlo
```c
$ sudo dmesg -c
```

Borrarlo sin representarlo
```c
$ sudo dmesg -C
```

No imprimir timestamps
```c
$ sudo dmesg -t
```

Imprimir timestamps human ready
```c
$ sudo dmesg -T
```

Imprimir solo mensajes con cierto nivel de prioridad
```c
$ sudo dmesg -l err,warn
```

Imprimir prioridad de los mensajes al inicio del mensaje
```c
$ sudo dmesg -x
```

## Threads